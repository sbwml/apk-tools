on:
  workflow_dispatch:
  push:
    tags:
      - '*'

env:
  ALPINE_DEPS: "make gcc git scdoc musl-dev linux-headers openssl-dev zlib-dev lua5.3-dev lua5.3-lzlib cmocka-dev python3-dev"
  ALPINE_STATIC_DEPS: "zlib-static openssl-libs-static"

name: Build apk-tools (static)

jobs:
  build_static:
    name: build:static (${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch:
          - x86_64
    container:
      image: alpinelinux/build-base:latest-${{ matrix.arch }}
      options: --user root
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare environment and build
        env:
          ARCH: ${{ matrix.arch }}
          ALPINE_DEPS: ${{ env.ALPINE_DEPS }}
          ALPINE_STATIC_DEPS: ${{ env.ALPINE_STATIC_DEPS }}
        run: |
          set -euo pipefail
          if [ "$ARCH" = "x86_64" ]; then EXTRA="--repository=$(sed -ne 's/main/community/p' < /etc/apk/repositories) shellcheck"; fi
          if command -v abuild-apk >/dev/null 2>&1; then
            abuild-apk add -u meson $ALPINE_DEPS $ALPINE_STATIC_DEPS zstd-dev zstd-static $EXTRA
          else
            apk update || true
            apk add --no-cache meson $ALPINE_DEPS $ALPINE_STATIC_DEPS zstd-dev zstd-static
          fi
          meson setup --auto-features=enabled build
          ninja -C build
          meson setup build-static -Dc_link_args=-static -Ddefault_library=static -Dprefer_static=true
          ninja -C build-static src/apk
          meson test -C build || true
          # ensure deterministic static artifact name
          if [ -f build-static/src/apk ]; then
            install -s -m0755 build-static/src/apk build-static/src/apk.static-$ARCH
          elif ls build-static/src/apk.* >/dev/null 2>&1; then
            for f in build-static/src/apk.*; do
              cp -a "$f" build-static/src/apk.static-$ARCH || true
            done
          fi

      - name: Upload test log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: meson-testlog-${{ matrix.arch }}
          path: build/meson-logs/testlog.txt

      - name: Upload junit reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-${{ matrix.arch }}
          path: build/**/*.junit.xml

      - name: Upload static binary artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: apk.static-${{ matrix.arch }}
          path: build-static/src/apk.static-${{ matrix.arch }}

  publish_release:
    name: publish-static (release)
    runs-on: ubuntu-latest
    needs: build_static
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List downloaded artifacts
        run: |
          echo "artifacts content:"
          find artifacts -type f -print || true

      - name: Create GitHub Release and upload static binaries
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          files: artifacts/**/apk.static-*
          body: "Release ${{ github.ref_name }}"

      - name: Done
        run: echo "Release created and static binaries uploaded."
